import os; from os import path
from sikuli import *
import traceback
from common import PowerTools, Workspace, Project
from common.utils import ScreenUtils, XmlUtils

Settings.OcrTextSearch = True
Settings.OcrTextRead = True
#this needs to be .9 or the edit icon will match the cancel icon (pencil vs. x)
Settings.MinSimilarity = .9
setAutoWaitTimeout(120)
try:
	FIVE_MINUTES = 60 * 5
	powertools = PowerTools()
	region = powertools.open()

	def app_error(event):
		raise Exception("An error occured.")
	region.onAppear("1424300912166.png", app_error)
	region.observe(True)
	workspace = Workspace()
	workspace.configure_if_required()

	project = Project()
	project.open_or_create_or_join()

	wait("1417485496099.png")
	click("1417485496099.png")
	wait("1417484062075.png")
	wait("1417481345687.png")
	click("1417481345687.png")
	click("1417550609672.png")
	region = find("1417550637810.png").below(20)
	click(region)
	type("a",KeyModifier.CTRL)
	type(Key.BACKSPACE)
	paste("FIC Homeowners")
	region = region.nearby(70)
	region.find("FIC Homeowners")
	find("1417484062075.png").below(150).click("1417481345687.png")
	click("1417556044158.png")
	click("1417556097855.png")
	type("B")
	type(Key.TAB)
	type("1")
	find("1417481292451.png").right().click("1417481345687.png")
	click("1423509606590.png")
	region = find("1417482847118.png")
	dragDrop(region, Location(region.x, region.y + 150))
	doubleClick("1417483936005.png")
	click("1417484062075.png")
	wait("1417485496099.png")
	click("1417484201724.png")
	region = find("1417557161953.png").below(200)
	region.doubleClick("1417557196538.png")
	wait("1417485425073.png")
	region = find("1417485425073.png").below(20)
	click(region)
	wait("1417485496099.png")
	click("1417485496099.png")
	wait("1417481345687.png")
	click("1417481345687.png")
	click("1417557313764.png")
	click("1417557484758.png")
	click("1417557549277.png")
	wait("1417485496099.png")
	wait("1417485425073.png")
	region = find("1417485425073.png").below(20)
	click(region)
	click("1417485496099.png")
	wait("1417481345687.png")
	click("1417481345687.png")
	click("1417557708611.png")
	click("1417557484758.png")
	click("1417557762542.png")
	wait("1417557929097.png", FIVE_MINUTES)

	click("1417558028672.png")
	region = find("1417558066947.png").below(20)
	click(region)
	click("1417485496099.png")
	wait("1417481345687.png")
	click("1417481345687.png")
	click("1417558283578.png")
	click("1417557484758.png")
	click("1417557549277.png")
	wait("1417485496099.png")
	wait("1417558066947.png")
	region = find("1417558066947.png").below(20)
	click(region)
	click("1417485496099.png")
	wait("1417481345687.png")
	click("1417481345687.png")
	click("1417558780348.png")
	click("1417557484758.png")
	click("1417558829017.png")
	wait("1417557929097.png", FIVE_MINUTES)

	#countrywide and state are now managed
	
	click("1418330539729.png")
	click("1418412907465.png")
	click("1417485496099.png")
	wait("1417484062075.png")
	region = find("1418332087241.png").right()
	region.click("1417481345687.png")
	click("1423509606590.png")
	region = find("1418336753605.png")
	dragDrop(region, Location(region.x, region.y + 130))
	click("1418335485746.png")
	click(Pattern("1418335528376.png").exact())
	click("1418335583333.png")
	click("1417484062075.png")
	wait("1417485496099.png")
	click("1418336237711.png")
	click("1418336292620.png")
	click("1417485496099.png")
	wait("1418336753605.png")
	region = find("1418336753605.png")
	dragDrop(region, Location(region.x, region.y + 155))
	click("1418337553177.png")
	region = find("1418337659465.png").grow(10).right()
	region.click(Pattern("1417481345687.png").similar(0.75))
	click("1418342311515.png")
	options = find("1418342336092.png")
	region = options.right().click("1417481345687.png")
	click("1418337838668.png")
	options.below().click("1418337885758.png")
	wait(1)
	paste("Palm Fronds")
	type(Key.TAB)
	paste("Palm Fronds")
	click("1417484062075.png")
	wait("1417485496099.png")
	
	myPath = path.join(project.path, "src/com/demo/uw/common/product/model/template/fic/homeowners/ca/v01_00_00/list.xml")
	assert path.exists(myPath), "Path not found: " + myPath
	print myPath
	expected = '<option value="Palm Fronds" name="Palm Fronds" />'
	xpath = "./coderefs/coderef[@name='roof-type']/options/option[@value='Palm Fronds']"
	assert XmlUtils.areElementsEqual(myPath, xpath, expected), "Palm Fronds not found in xml file."
	
	if exists("1418338064467.png") is not None:
		click("1418338064467.png")
		click("1418338141044.png")
	if exists("1418683093146.png") is not None:
		click("1418683093146.png")
		
	print ("starting local tomcat instance")

	wait("1418338280367.png", FIVE_MINUTES)
	region = find("1418338395486.png").right(40).nearby(-5)
	wait(0.5)
	doubleClick(region)
	wait(0.5)
	paste("admin")
	wait(0.5)
	type(Key.TAB)
	wait(0.5)
	paste("9999")
	click("1418338280367.png")
	wait("1418341639863.png",  FIVE_MINUTES)
	click("1418341639863.png")
	wait("1418341715076.png")
	region = find("1418341715076.png").right(120)
	click(region)
	paste("11/30/2014")
	type(Key.TAB)
	type("C")
	type(Key.TAB)
	type("F")
	type(Key.TAB)
	type(Key.ENTER)
	wait("1418342925004.png")
	click("1418342925004.png")

	wait("1418342990235.png")
	region = find("1418342990235.png").right(30).right(30)
	doubleClick(region)
	paste("Agent1")
	type(Key.TAB)
	wait(2)
	region = find("1418343254876.png").right(67).right(30)
	click(region)
	wait("Civil Servant")
	type("C")
	region = find("1421881152301.png").right(60).right(30)
	click(region)
	wait("Individual")
	type("I")
	type(Key.TAB)
	wait("1418348560788.png")
	region = find("1418348560788.png").below(25)
	click(region)
	#name fields
	paste("asdf") #First
	type(Key.TAB)
	type(Key.TAB)
	paste("asdf") #last
	type(Key.TAB)
	type(Key.TAB)
	paste("asdf, asdf") #Name
	type(Key.TAB)
	type(Key.TAB)
	type(Key.TAB)
	type(Key.TAB)
	paste("100 Great Oaks Blvd")
	type(Key.TAB)
	type(Key.TAB)
	paste("San Jose")
	type(Key.TAB)
	type("C")
	type(Key.TAB)
	paste("95119")
	region = find("1418348560788.png").right(30)
	click(region)
	type(Key.END)
	click("1418344068047.png")
	wait("1418343750585.png")
	region = find("1418343750585.png").right(40)
	click(region)
	paste("0")
	type(Key.TAB)
	type("N")
	type(Key.TAB)
	paste("0")
	type(Key.END)
	click("1418344068047.png")
	wait("1418344137594.png")
	region = find("1418344137594.png").right(50).right(30)
	click(region)
	if exists("1418344238902.png") is not None:
		print "Palm Fronds found."
	else:
		print "Palm Fronds not found."
except (Exception, FindFailed) as e:
	screen_utils = ScreenUtils()
	file_path = screen_utils.capture_screen()
	print "Error:", sys.exc_info()[1]
	print traceback.format_exc()
	print "Captured screen shot at: " + file_path
	print "---------------------------\n"
	wait(1)
	raise e